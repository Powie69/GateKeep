var messageCount=0;let getMessageDebounce=!0;const msgElement=document.querySelector(".logs-item_template"),dialogElements=document.querySelectorAll(".update, .view");function fetchInfo(){return fetch("profile/getData",{method:"post",credentials:"include"}).then(e=>{if(!(e.status>=400))return e.json();console.warn("fetchInfo")}).then(e=>e).catch(e=>{console.error(e)})}function fetchMessages(e,t){if(!e||void 0==t||e>=25||t<=-1){console.log("bad data (client)");return}return fetch("profile/getMessage",{method:"post",credentials:"include",headers:{"Content-Type":"application/json"},body:`{"limit": ${e}, "offset": ${t}}`}).then(e=>{if(!(e.status>=400))return e.json();console.warn("fetchMessage")}).then(e=>e).catch(e=>{console.error(e)})}function fetchQrcode(){fetch("profile/getQrcode",{method:"post",credentials:"include"}).then(e=>{if(!(e.status>=400))return e.blob();console.warn("wong (client)")}).then(e=>{document.querySelector(".qr-img").src=URL.createObjectURL(e)}).catch(e=>{console.error(e)})}function updateMessage(e){if(e)for(let t=0;t<e.length;t++){let n=document.importNode(msgElement.content,!0).querySelector(".logs-item");n.querySelector(".logs-item-desc ._time").innerText=new Date(e[t].time).toLocaleTimeString("en-US",{timeZone:"Asia/Manila",hour12:!0,hour:"numeric",minute:"2-digit"}),n.querySelector(".logs-item-desc ._date").innerText=new Date(e[t].time).toLocaleDateString("en-US",{month:"long",day:"numeric"}),1==e[t].isIn?(n.querySelector(".logs-item-title span").innerText="IN",n.querySelector(".logs-item-title i").innerText="Login",n.querySelector(".logs-item-desc ._isIn").innerText="arrived"):(n.querySelector(".logs-item-title span").innerText="OUT",n.querySelector(".logs-item-title i").innerText="Logout",n.querySelector(".logs-item-desc ._isIn").innerText="left"),document.querySelector(".logs-container").appendChild(n),messageCount++}}function updateInfo(){fetchInfo().then(e=>{e&&(e.lastName&&(document.querySelector(".lastName p").innerText=e.lastName),e.firstName&&(document.querySelector(".firstName p").innerText=e.firstName,msgElement.content.querySelector("._name").innerText=e.firstName),e.middleName&&(document.querySelector(".middleName p").innerText=e.middleName),e.lrn&&(document.querySelector(".lrn p").innerText=e.lrn),e.age&&(document.querySelector(".age p").innerText=e.age),void 0!=e.sex&&(1==e.sex?document.querySelector(".sex p").innerText="Male":document.querySelector(".sex p").innerText="Female"))})}function updateViewDialog(e){for(var t in e){if(void 0!=e[t]&&"sex"==t){1==e[t]?document.querySelector(".view-sex p").innerText="Male":document.querySelector(".view-sex p").innertext="Female";continue}void 0!=e[t]&&(document.querySelector(`.view-${t} p`).innerText=e[t])}}function viewShow(){window.innerWidth<=600?window.location.href="./viewInfo.html":(document.querySelector(".view").showModal(),fetchInfo().then(e=>{updateViewDialog(e)}))}updateInfo(),fetchQrcode(),fetchMessages(10,messageCount).then(e=>{updateMessage(e)}),dialogElements.forEach(e=>{e.addEventListener("click",t=>{let n=e.getBoundingClientRect();(t.clientX<n.left||t.clientX>n.right||t.clientY<n.top||t.clientY>n.bottom)&&e.close()})}),document.querySelector(".logs-container").addEventListener("scrollend",function(){getMessageDebounce&&this.clientHeight+this.scrollTop>=this.scrollHeight-60&&(fetchMessages(5,messageCount).then(e=>{updateMessage(e)}),getMessageDebounce=!1,setTimeout(function(){getMessageDebounce=!0},500))}),document.querySelector("._logout").addEventListener("click",()=>{fetch("/profile/logout",{method:"post",credentials:"include"}).then(e=>{!(e.status>=400)&&location.reload()}).catch(e=>{console.error(e)})});