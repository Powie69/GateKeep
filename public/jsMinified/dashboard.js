let messageCount=0,getMessageDebounce=!0;const displayName=document.querySelector(".overlay").getAttribute("DisplayName"),msgElement=document.querySelector(".logs-item_template"),dialogElements=document.querySelectorAll(".viewDialog"),ws=new WebSocket("ws://localhost:3000/ws");function fetchMessages(e,t){if(!e||void 0==t||e>=25||t<=-1){console.log("bad data (client)");return}return fetch("profile/getMessage",{method:"post",headers:{"Content-Type":"application/json"},body:`{"limit": ${e}, "offset": ${t}}`}).then(e=>{if(!(e.status>=400))return e.json();console.warn("fetchMessage")}).then(e=>e).catch(e=>{console.error(e)})}function updateMessage(e){if(e)for(let t=0;t<e.length;t++){let n=document.importNode(msgElement.content,!0).querySelector(".logs-item");n.querySelector(".logs-item-desc ._time").innerText=new Date(e[t].time).toLocaleTimeString("en-US",{timeZone:"Asia/Manila",hour12:!0,hour:"numeric",minute:"2-digit"}),n.querySelector(".logs-item-desc ._date").innerText=new Date(e[t].time).toLocaleDateString("en-US",{month:"long",day:"numeric"}),1==e[t].isIn?(n.querySelector(".logs-item-title span").innerText="IN",n.querySelector(".logs-item-title i").innerText="Login",n.querySelector(".logs-item-desc ._isIn").innerText="arrived"):(n.querySelector(".logs-item-title span").innerText="OUT",n.querySelector(".logs-item-title i").innerText="Logout",n.querySelector(".logs-item-desc ._isIn").innerText="left"),document.querySelector(".logs-container").appendChild(n),messageCount++}}function handleDropdown(e){"false"===e.attributes.isDropdownOpen.value?(e.setAttribute("isDropdownOpen","true"),e.nextElementSibling.querySelector("menu").style.display="inline"):"true"===e.attributes.isDropdownOpen.value&&(e.setAttribute("isDropdownOpen","false"),e.nextElementSibling.querySelector("menu").style.removeProperty("display"))}function collapseSection(e,t){e.classList.toggle("collapse"),t.classList.toggle("up")}function sendNotification(e,t){if("Notification"in window){if("denied"===Notification.permission||"default"===Notification.permission){Notification.requestPermission().then(n=>{"granted"===n&&new Notification(e,t)});return}new Notification(e,t)}}fetchMessages(20,messageCount).then(e=>{updateMessage(e)}),("denied"!==Notification.permission||"default"===Notification.permission)&&setTimeout(()=>{Notification.requestPermission()},12e4),document.addEventListener("click",e=>{!(e.target.closest(".dropdown-contain")||e.target.closest(".dropdown-button"))&&document.querySelectorAll(".dropdown").forEach(e=>{e.querySelector(".dropdown-contain menu").style.removeProperty("display"),e.querySelector(".dropdown-button").setAttribute("isDropdownOpen","false")})}),document.querySelector(".logs-container").addEventListener("scrollend",function(){getMessageDebounce&&this.clientHeight+this.scrollTop>=this.scrollHeight-60&&(fetchMessages(5,messageCount).then(e=>{updateMessage(e)}),getMessageDebounce=!1,setTimeout(function(){getMessageDebounce=!0},500))}),dialogElements.forEach(e=>{e.addEventListener("click",t=>{let n=e.getBoundingClientRect();(t.clientX<n.left||t.clientX>n.right||t.clientY<n.top||t.clientY>n.bottom)&&e.close()})}),ws.onmessage=e=>{let t;try{t=JSON.parse(e.data)}catch(n){console.error(n)}let i=t.isIn?"arrived":"left",o=t.isIn?"Login":"Logout",r=document.importNode(msgElement.content,!0).querySelector(".logs-item");r.querySelector(".logs-item-desc ._time").innerText=new Date(t.time).toLocaleTimeString("en-US",{timeZone:"Asia/Manila",hour12:!0,hour:"numeric",minute:"2-digit"}),r.querySelector(".logs-item-desc ._date").innerText=new Date(t.time).toLocaleDateString("en-US",{month:"long",day:"numeric"}),r.querySelector(".logs-item-title i").innerText=o,r.querySelector(".logs-item-desc ._isIn").innerText=i,r.querySelector(".logs-item-title span").innerText=t.isIn?"IN":"OUT",sendNotification(`${displayName} ${i} at ${new Date(t.time).toLocaleTimeString("en-US",{timeZone:"Asia/Manila",hour12:!0,hour:"numeric",minute:"2-digit"})}`,{body:`${new Date(t.time).toLocaleDateString("en-US",{month:"long",day:"numeric"})}`,icon:`/images/${o}.svg`}),document.querySelector(".logs-container").insertBefore(r,document.querySelector(".logs-container").firstChild),messageCount++},ws.onerror=e=>{console.error(e)};