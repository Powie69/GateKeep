const sections={7:["love","kindness","hope","faith"],8:["matthew","jeremiah","psalm","john"],9:["thomas","joseph","james","paul"],10:["zeus","aphrodite","athena","poseidon"],11:["",""],12:["",""]},dialogElements=document.querySelectorAll(".logsDialog, .infoDialog, .editDialog, .addDialog, .bulkAddDialog");let getMessageDebounce=!0,messageCount=0,isBulkAddValid=!1;async function submitQuery(e){e.preventDefault();try{let t=Object.fromEntries(new FormData(e.target).entries());if(0==t.query.length&&void 0===t.searchLevel&&void 0===t.searchSection)return console.log("bad data (client)");let r=await fetch("/admin/query",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(t)});if(!r.ok)return 404===r.status&&(document.querySelector(".main-title").innerText=`no results for “${t.query}”`),console.warn("sumting wong");displayData(await r.json())}catch(n){console.error(n)}}async function submitEditInfo(e){e.preventDefault();try{let t=Object.fromEntries(new FormData(e.target).entries());if(void 0!==t.email&&0!==t.email.length&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t.email)||void 0!==t.phoneNumber&&0!==t.phoneNumber.length&&!/^09\d{9}$/.test(t.phoneNumber)||void 0!==t.lrn&&0!==t.lrn.length&&!/^[1-6]\d{5}(0\d|1\d|2[0-5])\d{4}$/.test(t.lrn)||void 0!==t.gradeLevel&&0!==t.gradeLevel.length&&(t.gradeLevel<7||t.gradeLevel>12)||void 0!==t.zip&&0!==t.zip.length&&!/^(0[4-9]|[1-9]\d)\d{2}$/.test(t.zip))return console.log("bad data"),submitEditOnErr("client","bad data");for(let r in t)if(void 0!==t[r]&&0!==t[r].length&&t[r].length>=255)return submitEditOnErr("client","bad data");t.userId=e.target.parentElement.getAttribute("userId"),console.log(e.target.parentElement);let n=await fetch("/admin/updateInfo",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(t)}),o=await n.json();if(!n.ok)return submitEditOnErr(n.status,o.message);document.querySelector(".editDialog").close(),alert("big success")}catch(i){console.error(i)}}async function submitAddAccount(e){e.preventDefault();try{let t=Object.fromEntries(new FormData(e.target).entries());if(void 0===t.email||0===t.email.length||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t.email)||void 0===t.phoneNumber||0===t.phoneNumber.length||!/^09\d{9}$/.test(t.phoneNumber)||void 0===t.password||0===t.password.length||void 0===t.lrn||0===t.lrn.length||!/^[1-6]\d{5}(0\d|1\d|2[0-5])\d{4}$/.test(t.lrn)||void 0===t.lastName||0===t.lastName.length||void 0===t.firstName||0===t.firstName.length||void 0!==t.gradeLevel&&0!=t.gradeLevel.length&&(t.gradeLevel<7||t.gradeLevel>12)||void 0!==t.zip&&0!=t.zip.length&&!/^(0[4-9]|[1-9]\d)\d{2}/.test(t.zip))return console.log("bad data");let r=await fetch("/admin/create",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(t)}),n=await r.json();if(!r.ok)return addAccountOnErr(r.status,n.message);addAccountOnSuccess(n)}catch(o){console.error(o)}}async function submitBulkAddAccount(e){e.preventDefault();try{let t=Object.fromEntries(new FormData(e.target).entries());if(!isBulkAddValid)return;let r=await fetch("/admin/bulkCreate",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(t)}),n=await r.json();if(!r.ok){alert(`${r.status}: ${n.message}`),console.log(n.message);return}alert(`${r.status}: ${n.message}`)}catch(o){console.error(o)}}function displayData(e){if(void 0!==e){document.querySelectorAll(".main-table-contain > div.main-table-contain-item").forEach(e=>{document.querySelector(".main-table-contain").removeChild(e)});for(let t=0;t<e.length;t++){let r=document.importNode(document.querySelector(".main-table-contain_template").content,!0).querySelector(".main-table-contain-item");for(let n in e[t]){let o=r.querySelector(`#item-${n}`);null!=o&&void 0!=e[t][n]&&(o.innerText=e[t][n],o.classList.remove("_nullItems"))}r.querySelector(".main-table-contain-item-buttons").setAttribute("userId",e[t].userId),document.querySelector(".main-table-contain").appendChild(r)}document.querySelector(".main-title").innerText=`${e.length} results found`}}function getSection(e){document.querySelectorAll(".search-section-item").forEach((t,r)=>{if(!e){t.setAttribute("hidden",""),t.innerHTML="",document.querySelector(".search-section-text").selected=!0,document.querySelector(".search-section-none").removeAttribute("hidden"),document.querySelector(".search-section-any").setAttribute("hidden","");return}if(!sections[e][r]){t.setAttribute("hidden","");return}t.innerHTML=sections[e][r],t.value=sections[e][r],document.querySelector(".search-section-none").setAttribute("hidden",""),document.querySelector(".search-section-any").removeAttribute("hidden"),document.querySelector(".search-section-text").selected=!0,t.removeAttribute("hidden")})}async function fetchMessages(e,t,r){if(!e||!r||!Number.isSafeInteger(t)||e>=25||t<0){console.log("bad data");return}return await fetch(`/admin/messages/${r}?offset=${t}&limit=${e}`,{headers:{"Content-Type":"application/json"}}).then(e=>{if(!(e.status>=400))return e.json();console.warn("something wrong")}).then(e=>e).catch(e=>{console.error(e)})}async function fetchInfo(e,t){return 0===e.length&&console.log("bad data (client)"),await fetch(`/admin/info/${e}${t?"?qr":""}`,{headers:{"Content-Type":"application/json"}}).then(e=>{if(!(e.status>=400))return e.json();console.warn("something wrong")}).then(e=>e).catch(e=>{console.error(e)})}async function openLogsDialog(e){let t=document.querySelector(".logsDialog");t.showModal(),t.setAttribute("userId",e.parentElement.getAttribute("userId")),t.setAttribute("userName",e.parentElement.parentElement.querySelector("#item-firstName").innerText);let r=await fetchMessages(15,messageCount,e.parentElement.getAttribute("userId"));updateMessage(r)}async function openInfoDialog(e){document.querySelector(".infoDialog").showModal();let t=await fetchInfo(e.parentElement.getAttribute("userId"),!0);updateInfo(t),console.log(t)}async function openEditDialog(e){document.querySelector(".editDialog").showModal(),document.querySelector(".editDialog").setAttribute("userId",e.parentElement.getAttribute("userId"));let t=await fetchInfo(e.parentElement.getAttribute("userId"),!1);updatePlaceholderInfo(t)}function openAddDialog(){document.querySelector(".addDialog").showModal()}function openBulkAddDialog(){document.querySelector(".bulkAddDialog").showModal(),document.querySelector(".bulkAddDialog").style.display="flex"}function submitEditOnErr(e,t){document.querySelector(".editDialog header p").innerText=e+": "+t,document.querySelector(".editDialog header p").style.removeProperty("visibility"),setTimeout(()=>{document.querySelector(".editDialog header p").style.visibility="hidden",document.querySelector(".editDialog header p").innerText=""},1e4)}function addAccountOnSuccess(e){document.querySelector(".addDialog").close(),alert(e.message)}function addAccountOnErr(e,t){document.querySelector(".addDialog header p").innerText=e+": "+t,document.querySelector(".addDialog header p").style.removeProperty("visibility"),setTimeout(()=>{document.querySelector(".addDialog header p").style.visibility="hidden",document.querySelector(".addDialog header p").innerText=""},1e4)}function checkBulkAdd(e){if("string"!=typeof e||0===e.length)return{ok:!1,accounts:0,errors:0,message:""};try{e=JSON.parse(e)}catch(t){return console.log(t),{ok:!1,accounts:0,errors:1,message:t.message}}if("object"!=typeof e||0===e.length)return{ok:!1,accounts:0,errors:1,message:"No accounts in json"};let r=0,n=0,o=new Set;for(let i=0;i<e.length;i++)o.has(e[i].lrn)&&n++,(void 0===e[i].email||0===e[i].email.length||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e[i].email)||void 0===e[i].phoneNumber||0===e[i].phoneNumber.length||!/^09\d{9}$/.test(e[i].phoneNumber)||void 0===e[i].password||0===e[i].password.length||void 0===e[i].lrn||0===e[i].lrn.length||!/^[1-6]\d{5}(0\d|1\d|2[0-5])\d{4}$/.test(e[i].lrn)||void 0===e[i].lastName||0===e[i].lastName.length||void 0===e[i].firstName||0===e[i].firstName.length||void 0!==e[i].gradeLevel&&0!=e[i].gradeLevel.length&&(e[i].gradeLevel<7||e[i].gradeLevel>12)||(e[i].zip,0!=e[i].zip.length&&!/^(0[4-9]|[1-9]\d)\d{2}/.test(e[i].zip)))&&n++,o.add(e[i].lrn),r++;return(console.log("40 ",e),0!==n)?{ok:!1,accounts:r,errors:n,message:"accounts have invalid values"}:{ok:!0,accounts:r,errors:n,message:""}}async function removeAccount(e){try{let t=await fetch("/admin/remove/check",{method:"POST",headers:{"Content-Type":"application/json"},body:`{"id": ${e}}`});if(!t.ok)return console.warn("something wrong");let r=await t.json();console.log(r);let n=prompt(`are you sure you want to delete the account of ${r.name}\n\n To confirm, retype LRN of user:`);if(null===n)return;if(n!=r.lrn)return alert("Wrong LRN!");let o=await removeAccountReq(e,n),i=await t.json();if(!t.ok){alert(`${t.status}: ${i.message}`),console.log(i.message);return}alert(`${o.status}: ${i.message}`)}catch(a){console.error(a)}}async function removeAccountReq(e,t){if(""==typeof e||12!==t.length){console.warn("bad");return}return await fetch("http://localhost:3000/admin/remove/confirm",{method:"DELETE",headers:{"Content-Type":"application/json"},body:`{"id": "${e}", "lrn": "${t}"}`}).then(e=>e).then(e=>e).catch(e=>{console.error(e)})}function updateMessage(e){if(e)for(let t=0;t<e.length;t++){let r=document.importNode(document.querySelector(".logsDialog-container-item_template").content,!0).querySelector(".logsDialog-container-item");r.querySelector(".logsDialog-container-item-desc_name").innerText=document.querySelector(".logsDialog").getAttribute("userName"),r.querySelector(".logsDialog-container-item-desc_time").innerText=new Date(e[t].time).toLocaleTimeString("en-US",{timeZone:"Asia/Manila",hour12:!0,hour:"numeric",minute:"2-digit"}),r.querySelector(".logsDialog-container-item-desc_date").innerText=new Date(e[t].time).toLocaleDateString("en-US",{month:"long",day:"numeric"}),1==e[t].isIn?(r.querySelector(".logsDialog-container-item-title span").innerText="IN",r.querySelector(".logsDialog-container-item-title i").innerText="Login",r.querySelector(".logsDialog-container-item-desc_isIn").innerText="arrived"):(r.querySelector(".logsDialog-container-item-title span").innerText="OUT",r.querySelector(".logsDialog-container-item-title i").innerText="Logout",r.querySelector(".logsDialog-container-item-desc_isIn").innerText="left"),document.querySelector(".logsDialog-container").appendChild(r),messageCount++}}function updateInfo(e){if(e){for(let t in e){let r=document.querySelector(`#info-${t}`);if(r){if("info-qrId"==r.id&&e[t]){r.innerText=`{"qrId":"${e[t]}"}`,r.classList.remove("_nullItems");continue}e[t]&&(r.innerText=e[t],r.classList.remove("_nullItems"))}}document.querySelector("#info-qrImage").src=`/admin/qr-image/${e.userId}`}}function updatePlaceholderInfo(e){if(e)for(let t in (console.log(e), e)){let r=document.querySelector(`.editDialog-form-${t}`);if(r){if("SELECT"==r.tagName&&e[t]){document.querySelector(`.editDialog-form-${t}_placeholder`).innerHTML=e[t];continue}e[t]&&(r.placeholder=e[t])}}}document.querySelector(".logsDialog-container").addEventListener("scrollend",function(){getMessageDebounce&&this.clientHeight+this.scrollTop>=this.scrollHeight-60&&(fetchMessages(5,messageCount,document.querySelector(".logsDialog").getAttribute("userId")).then(e=>{updateMessage(e)}),getMessageDebounce=!1,setTimeout(function(){getMessageDebounce=!0},500))}),dialogElements.forEach(e=>{e.addEventListener("click",t=>{if("SELECT"===t.target.tagName||t.target.closest("select"))return;let r=e.getBoundingClientRect();(t.clientX<r.left||t.clientX>r.right||t.clientY<r.top||t.clientY>r.bottom)&&e.close()})}),document.querySelector(".logsDialog").addEventListener("close",()=>{messageCount=0,document.querySelector(".logsDialog").setAttribute("userId",""),document.querySelector(".logsDialog").setAttribute("userName",""),document.querySelectorAll(".logsDialog-container > div.logsDialog-container-item").forEach(e=>{document.querySelector(".logsDialog-container").removeChild(e)})}),document.querySelector(".infoDialog").addEventListener("close",()=>{document.querySelector("#info-qrId + img").src="",document.querySelectorAll(".infoDialog-container > span span").forEach(e=>{e.classList.add("_nullItems"),e.innerText=""})}),document.querySelector(".editDialog").addEventListener("close",()=>{document.querySelectorAll(".editDialog-form input").forEach(e=>{e.placeholder=""}),document.querySelectorAll(".editDialog-form select").forEach(e=>{e.children[0].innerText=""}),document.querySelector(".editDialog-form").reset()}),document.querySelector(".addDialog").addEventListener("close",()=>{document.querySelector(".addDialog-form").reset(),document.querySelector(".addDialog header p").style.visibility="hidden",document.querySelector(".addDialog header p").innerText=""}),document.querySelector(".bulkAddDialog").addEventListener("close",e=>{e.target.style.removeProperty("display"),e.target.querySelector(".bulkAddDialog-form").reset()}),document.querySelector(".bulkAddDialog-form textarea").addEventListener("change",e=>{let t=checkBulkAdd(e.target.value);if(isBulkAddValid=t.ok,document.querySelector(".bulkAddDialog-preview-accounts span").innerText=t.accounts,document.querySelector(".bulkAddDialog-preview-errors span").innerText=t.errors,""!==t.message){document.querySelector(".bulkAddDialog-preview p").innerText=t.message,document.querySelector(".bulkAddDialog-preview p").style.removeProperty("visibility");return}document.querySelector(".bulkAddDialog-preview p").innerText="",document.querySelector(".bulkAddDialog-preview p").style.visibility="hidden"});